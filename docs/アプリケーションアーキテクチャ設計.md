# アプリケーションアーキテクチャ設計

## 1. 全体アーキテクチャ

### 1.1 モジュール構成

アプリケーションは以下の主要モジュールで構成されます：

1. **メインアプリケーション (main.py)**
   - アプリケーションのエントリーポイント
   - 各モジュールの初期化と連携

2. **UI管理モジュール (ui_manager.py)**
   - メインウィンドウとUI要素の管理
   - ユーザー操作のイベントハンドリング
   - 設定画面の管理

3. **スクリーンキャプチャモジュール (screen_capture.py)**
   - 画面範囲選択機能
   - スクリーンショット取得機能

4. **OCR処理モジュール (ocr_processor.py)**
   - Tesseract OCRとの連携
   - 画像からのテキスト抽出処理
   - 言語検出と前処理

5. **翻訳モジュール (translator.py)**
   - OpenAI APIとの連携
   - Gemini APIとの連携
   - 翻訳処理の抽象化

6. **設定管理モジュール (settings_manager.py)**
   - APIキーの保存と読み込み
   - ユーザー設定の管理
   - 設定の永続化

7. **ユーティリティモジュール (utils.py)**
   - 共通機能や補助関数
   - エラーハンドリング
   - ロギング

### 1.2 データフロー

1. **キャプチャフロー**
   - ユーザーがキャプチャトリガーを起動
   - 範囲選択UI表示
   - ユーザーが範囲を選択
   - 選択範囲の画像をキャプチャ
   - キャプチャ画像をOCRモジュールに渡す

2. **OCRフロー**
   - キャプチャ画像を受け取る
   - 必要に応じて前処理（リサイズ、コントラスト調整など）
   - Tesseract OCRでテキスト抽出
   - 抽出テキストを翻訳モジュールに渡す

3. **翻訳フロー**
   - 抽出テキストを受け取る
   - 設定から選択されたAPI（OpenAIまたはGemini）を確認
   - 対応するAPIを使用してテキスト翻訳
   - 翻訳結果をUI管理モジュールに渡す

4. **結果表示フロー**
   - 原文と翻訳結果を受け取る
   - 結果表示UIを更新
   - コピー機能の提供

### 1.3 依存関係管理

- **外部ライブラリ**:
  - PyQt5: UIフレームワーク
  - pytesseract: OCR処理
  - openai: OpenAI API連携
  - google-generativeai: Gemini API連携
  - Pillow: 画像処理

- **内部依存関係**:
  - メインアプリケーション → 各モジュール
  - UI管理モジュール → スクリーンキャプチャ、OCR処理、翻訳、設定管理
  - スクリーンキャプチャモジュール → ユーティリティ
  - OCR処理モジュール → ユーティリティ、設定管理
  - 翻訳モジュール → ユーティリティ、設定管理

## 2. UIデザイン

### 2.1 メインウィンドウ

メインウィンドウは以下の要素で構成されます：

1. **メニューバー**
   - ファイルメニュー: 終了
   - 設定メニュー: API設定、言語設定
   - ヘルプメニュー: 使い方、バージョン情報

2. **ツールバー**
   - キャプチャボタン: 範囲選択モードを開始
   - 設定ボタン: 設定ダイアログを開く
   - 言語選択ドロップダウン: 翻訳先言語の選択

3. **結果表示エリア**
   - 原文テキスト表示（コピーボタン付き）
   - 翻訳テキスト表示（コピーボタン付き）
   - キャプチャ画像のプレビュー（オプション）

4. **ステータスバー**
   - 現在の状態表示
   - 選択されているAPI情報
   - エラーメッセージ（発生時）

### 2.2 範囲選択UI

範囲選択UIは以下の特徴を持ちます：

1. **半透明オーバーレイ**
   - 画面全体を覆う半透明レイヤー
   - 選択範囲は透明に表示

2. **選択操作**
   - マウスドラッグで矩形範囲を選択
   - 選択範囲の調整が可能
   - Escキーでキャンセル
   - Enterキーまたはダブルクリックで確定

3. **視覚的フィードバック**
   - 選択範囲の境界線表示
   - 選択範囲のサイズ情報表示

### 2.3 設定ダイアログ

設定ダイアログは以下のタブで構成されます：

1. **API設定タブ**
   - OpenAI APIキー入力フィールド
   - Gemini APIキー入力フィールド
   - 使用するAPIの選択（ラジオボタン）
   - APIキーの検証ボタン

2. **言語設定タブ**
   - 翻訳先言語の選択（ドロップダウン）
   - OCR言語の設定（チェックボックス: 日本語、英語）

3. **一般設定タブ**
   - 起動時の動作設定
   - ホットキー設定（オプション）
   - UIテーマ設定（オプション）

### 2.4 ワイヤーフレーム

#### メインウィンドウ
```
+-----------------------------------------------+
| ファイル  設定  ヘルプ                        |
+-----------------------------------------------+
| [キャプチャ] [設定] [言語選択▼]              |
+-----------------------------------------------+
| 原文:                                        |
| +-----------------------------------+ [コピー] |
| |                                   |         |
| |                                   |         |
| +-----------------------------------+         |
|                                               |
| 翻訳:                                        |
| +-----------------------------------+ [コピー] |
| |                                   |         |
| |                                   |         |
| +-----------------------------------+         |
+-----------------------------------------------+
| ステータス: 準備完了                          |
+-----------------------------------------------+
```

#### 範囲選択UI
```
+-----------------------------------------------+
|                                               |
|    +-------------------------+                |
|    |                         |                |
|    |     選択範囲            |                |
|    |                         |                |
|    +-------------------------+                |
|                                               |
|                                               |
|                                               |
|                                               |
|                                               |
+-----------------------------------------------+
```

#### 設定ダイアログ
```
+-----------------------------------------------+
| API設定 | 言語設定 | 一般設定 |               |
+-----------------------------------------------+
| OpenAI APIキー:                              |
| +-----------------------------------+         |
| |                                   |         |
| +-----------------------------------+         |
|                                               |
| Gemini APIキー:                              |
| +-----------------------------------+         |
| |                                   |         |
| +-----------------------------------+         |
|                                               |
| 使用するAPI:                                  |
| (●) OpenAI API                               |
| ( ) Gemini API                                |
|                                               |
| [検証]                [キャンセル] [保存]     |
+-----------------------------------------------+
```

## 3. クラス設計

### 3.1 主要クラス

1. **MainApplication**
   - アプリケーションのメインクラス
   - 各モジュールの初期化と連携

2. **MainWindow**
   - メインウィンドウのUIと操作を管理
   - 各UIコンポーネントの配置と連携

3. **ScreenCaptureWidget**
   - 範囲選択UIの実装
   - マウスイベント処理
   - 画面キャプチャ機能

4. **OCRProcessor**
   - Tesseract OCRとの連携
   - テキスト抽出処理

5. **TranslatorService**
   - 翻訳APIの抽象インターフェース
   
6. **OpenAITranslator**
   - OpenAI APIを使用した翻訳実装
   
7. **GeminiTranslator**
   - Gemini APIを使用した翻訳実装

8. **SettingsManager**
   - 設定の保存と読み込み
   - 設定ダイアログの管理

9. **SettingsDialog**
   - 設定UIの実装
   - 設定変更の処理

### 3.2 クラス関連図

```
MainApplication
    |
    +-- MainWindow
    |       |
    |       +-- ScreenCaptureWidget
    |       |
    |       +-- SettingsDialog
    |
    +-- OCRProcessor
    |
    +-- TranslatorService
    |       |
    |       +-- OpenAITranslator
    |       |
    |       +-- GeminiTranslator
    |
    +-- SettingsManager
```

## 4. 実装計画

### 4.1 フェーズ1: 基本構造とUI
- メインアプリケーションの骨格実装
- メインウィンドウUIの実装
- 設定ダイアログの実装

### 4.2 フェーズ2: スクリーンキャプチャ
- 範囲選択UIの実装
- スクリーンショット取得機能の実装

### 4.3 フェーズ3: OCR統合
- Tesseract OCRの統合
- テキスト抽出処理の実装

### 4.4 フェーズ4: 翻訳API統合
- OpenAI API連携の実装
- Gemini API連携の実装
- 翻訳処理の実装

### 4.5 フェーズ5: 統合とテスト
- 各モジュールの統合
- エラーハンドリングの実装
- 全体テスト

### 4.6 フェーズ6: パッケージング
- PyInstallerによる実行ファイル作成
- 依存関係の管理
- 配布パッケージの作成

## 5. 技術的考慮事項

### 5.1 セキュリティ
- APIキーの安全な保存（暗号化を検討）
- エラー時の機密情報漏洩防止

### 5.2 パフォーマンス
- OCR処理の最適化
- 非同期処理の活用（UI応答性の確保）

### 5.3 ユーザビリティ
- 直感的なUI設計
- エラーメッセージの明確化
- ツールチップやヘルプ情報の提供

### 5.4 拡張性
- 将来的な言語追加の容易さ
- 他の翻訳APIへの対応可能性
- プラグイン構造の検討

### 5.5 依存関係
- Tesseract OCRのインストール方法（バンドルか外部インストールか）
- 必要なPythonパッケージの管理
